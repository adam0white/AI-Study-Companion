<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.5</storyId>
    <title>Chat Modal Interface</title>
    <status>drafted</status>
    <generatedAt>2025-11-07T10:34:00Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-5-chat-modal-interface.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>student</asA>
    <iWant>a chat interface to interact with my companion</iWant>
    <soThat>I can have conversations and ask questions</soThat>
    <tasks>
      <task id="1">Create Chat Modal Component (AC: 1, 5, 7)</task>
      <task id="2">Create Chat Message Bubble Component (AC: 2, 8)</task>
      <task id="3">Create Chat Interface Container (AC: 1, 2, 5)</task>
      <task id="4">Create Message Input Component (AC: 3, 6)</task>
      <task id="5">Implement Typing Indicator Component (AC: 4)</task>
      <task id="6">Integrate Chat Interface with Card Gallery (AC: 1, 7)</task>
      <task id="7">Implement Message State Management (AC: 2, 6)</task>
      <task id="8">Apply Modern &amp; Playful Theme Styling (AC: 2, 3, 5, 8)</task>
      <task id="9">Accessibility Implementation (AC: 1, 3, 5)</task>
      <task id="10">Testing (All ACs)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1.5.1">Chat interface opens (modal on desktop, full-screen on mobile)</ac>
    <ac id="1.5.2">Chat message bubbles visible (companion and user messages)</ac>
    <ac id="1.5.3">Message input area with send button</ac>
    <ac id="1.5.4">Typing indicators when companion is responding</ac>
    <ac id="1.5.5">Responsive chat interface</ac>
    <ac id="1.5.6">Can type messages and see them appear</ac>
    <ac id="1.5.7">Chat interface can be closed to return to card gallery</ac>
    <ac id="1.5.8">Chat messages clearly differentiated (companion vs user)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="FR-13: Chat Interface">
        Primary interaction through conversational chat interface with natural language input/output, message history visible, typing indicators, and smooth conversation flow.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="Project Structure">
        Chat components in `src/components/chat/` directory. Uses shadcn/ui Dialog component as base for ChatModal. Follows React + Vite + Tailwind patterns.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic Technical Specification" section="AC-1.5: Chat Modal Interface Created">
        Chat interface opens as modal on desktop (centered, max-width 600px) and full-screen on mobile. Message bubbles display user (right-aligned, purple) and companion (left-aligned, gray) messages. Input field with send button, typing indicators, responsive design, keyboard accessible.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 1.5: Chat Modal Interface">
        Chat interface opens when Chat action card is clicked. Modal on desktop, full-screen on mobile. Message bubbles, input area, typing indicators, responsive, accessible via keyboard.
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Component Library: Chat Message Bubbles">
        Custom component for displaying companion and user messages. User messages: right-aligned, purple background (#8B5CF6). Companion messages: left-aligned, gray background. Message bubbles have proper spacing, smooth scrolling, optional avatar/timestamp.
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Modal Patterns">
        Medium size variant: Chat interface (full-screen on mobile, centered on desktop). Dismiss: Click outside to close, Escape key, explicit close button. Focus management: Auto-focus on input field when modal opens. Stacking: Single modal at a time.
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Color System">
        User messages: Primary purple (#8B5CF6) background. Companion messages: Gray background (#F3F4F6 or similar). Input border: Gray-200 (#E5E7EB), focus: Purple (#8B5CF6). Send button: Primary purple (#8B5CF6).
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Responsive Strategy">
        Mobile: &lt; 640px (full-screen modal, edge-to-edge). Desktop: &gt; 640px (centered modal, max-width 600px). Touch targets: Minimum 44x44px on mobile.
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Accessibility Strategy">
        WCAG 2.1 AA compliance. Keyboard navigation: Tab, Enter, Escape keys. Focus management: Auto-focus input when modal opens. Touch targets: Minimum 44x44px on mobile. ARIA labels for modal, input, buttons. Screen reader support for message content.
      </doc>
    </docs>
    <code>
      <file path="src/components/chat/ChatModal.tsx" kind="component" symbol="ChatModal" reason="Placeholder component exists, needs full implementation">
        Placeholder ChatModal component with TODO comments for modal overlay, chat message display, input field, WebSocket connection, and typing indicators.
      </file>
      <file path="src/components/layout/CardGallery.tsx" kind="component" symbol="CardGallery, ActionCardsGrid" reason="Card gallery layout component that chat modal will integrate with">
        Responsive card gallery layout with ActionCardsGrid. Mobile: 1 column, Tablet: 2 columns, Desktop: 3 columns. Chat action card exists in App.tsx.
      </file>
      <file path="src/components/layout/ActionCard.tsx" kind="component" symbol="ActionCard" reason="Action card component that Chat card uses, provides click handler pattern">
        Reusable action card component with icon, title, description, and onClick handler. Used for Chat, Practice, and Progress cards.
      </file>
      <file path="src/components/ui/card.tsx" kind="component" symbol="Card, CardHeader, CardContent" reason="shadcn/ui base card component, can be used for message bubbles">
        shadcn/ui Card component with CardHeader, CardContent, CardFooter subcomponents. Provides base styling and structure.
      </file>
      <file path="src/App.tsx" kind="component" symbol="App, handleChatClick" reason="Main app component with Chat card click handler that needs to open ChatModal">
        App component renders CardGallery with Chat action card. handleChatClick currently logs to console, needs to open ChatModal.
      </file>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="react" version="^19.2.0"/>
        <package name="react-dom" version="^19.2.0"/>
        <package name="@tanstack/react-query" version="^5.90.7"/>
        <package name="tailwindcss" version="^4.1.17"/>
        <package name="lucide-react" version="^0.553.0"/>
        <package name="class-variance-authority" version="^0.7.1"/>
        <package name="clsx" version="^2.1.1"/>
        <package name="tailwind-merge" version="^3.3.1"/>
      </ecosystem>
      <ecosystem name="dev">
        <package name="vitest" version="^3.2.4"/>
        <package name="@testing-library/react" version="^16.3.0"/>
        <package name="@testing-library/jest-dom" version="^6.9.1"/>
        <package name="typescript" version="~5.9.3"/>
      </ecosystem>
      <note>shadcn/ui Dialog component needs to be installed: `npx shadcn@latest add dialog`</note>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use shadcn/ui Dialog component as base for ChatModal (must install if not present)</constraint>
    <constraint>Follow React component patterns: Functional components with TypeScript, Props interfaces for type safety, Tailwind CSS classes for styling</constraint>
    <constraint>Modal responsive behavior: Desktop (centered, max-width 600px), Mobile (full-screen, edge-to-edge)</constraint>
    <constraint>Color system: User messages purple (#8B5CF6), Companion messages gray (#F3F4F6), Input focus purple (#8B5CF6)</constraint>
    <constraint>Accessibility: WCAG 2.1 AA compliance, keyboard navigation (Tab, Enter, Escape), ARIA labels, minimum 44x44px touch targets</constraint>
    <constraint>Component organization: Chat components in `src/components/chat/` directory, PascalCase naming, co-located test files</constraint>
    <constraint>State management: Use useState for message state (React Query deferred to Story 1.6 for persistent storage)</constraint>
    <constraint>No backend connection required yet (placeholder responses, Story 1.6 will connect to Durable Object)</constraint>
  </constraints>

  <interfaces>
    <interface name="ChatModal Props" kind="React Component Props" signature="interface ChatModalProps { open: boolean; onClose: () => void; }" path="src/components/chat/ChatModal.tsx"/>
    <interface name="MessageBubble Props" kind="React Component Props" signature="interface MessageBubbleProps { role: 'user' | 'companion'; content: string; timestamp?: string; }" path="src/components/chat/MessageBubble.tsx"/>
    <interface name="MessageInput Props" kind="React Component Props" signature="interface MessageInputProps { onSend: (message: string) => void; disabled?: boolean; }" path="src/components/chat/MessageInput.tsx"/>
    <interface name="TypingIndicator Props" kind="React Component Props" signature="interface TypingIndicatorProps { isTyping: boolean; }" path="src/components/chat/TypingIndicator.tsx"/>
    <interface name="ChatMessage Type" kind="TypeScript Type" signature="interface ChatMessage { id: string; role: 'user' | 'companion'; content: string; timestamp: string; }" path="src/types/chat.ts"/>
  </interfaces>

  <tests>
    <standards>
      Testing uses Vitest + React Testing Library + happy-dom. Component tests co-located with components (`.test.tsx`). Focus on high-value tests, not 100% coverage. Manual testing for visual design, responsive behavior, and accessibility.
    </standards>
    <locations>
      <location>src/components/chat/*.test.tsx</location>
      <location>src/test/setup.ts</location>
    </locations>
    <ideas>
      <test ac="1.5.1">Unit test: ChatModal opens/closes correctly when open prop changes</test>
      <test ac="1.5.1">Unit test: Escape key closes modal</test>
      <test ac="1.5.1">Component test: Modal responsive behavior (desktop vs mobile)</test>
      <test ac="1.5.2">Unit test: MessageBubble renders user messages (right-aligned, purple)</test>
      <test ac="1.5.2">Unit test: MessageBubble renders companion messages (left-aligned, gray)</test>
      <test ac="1.5.3">Unit test: MessageInput handles input and send</test>
      <test ac="1.5.3">Unit test: Send button disabled when input is empty</test>
      <test ac="1.5.4">Unit test: TypingIndicator shows/hides correctly</test>
      <test ac="1.5.5">Component test: ChatInterface responsive behavior across breakpoints</test>
      <test ac="1.5.6">Component test: Messages appear in conversation when sent</test>
      <test ac="1.5.7">Component test: Closing modal returns to card gallery</test>
      <test ac="1.5.8">Component test: Visual distinction between user and companion messages</test>
      <test ac="all">Manual test: Full chat flow (open, type, send, close)</test>
      <test ac="all">Manual test: Keyboard navigation (Tab, Enter, Escape)</test>
      <test ac="all">Manual test: Screen reader compatibility</test>
    </ideas>
  </tests>
</story-context>

